<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<style>
.header img {
  float: left;
  width: 75px;
  height: 75px;
  vertical-align: middle
  background: #FFF;
}
.header h1 {
  position: relative;
  top: 18px;
  left: 0px;
}
</style>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" type="image/jpg" href="images/marionette.jpg" />
  <title>See the Strings</title>
</head>
<body background="">
  <div class="header">
    <img src="images/marionette.jpg" alt="logo" />
    <h1>See the Strings</h1>
  </div>
  <br>
  <p>
  This tool makes it possible to generate <a href="http://en.wikipedia.org/wiki/Graph_drawing">
  graph drawings</a> to visualize the contributions and expenditures made by Political Action
  Committees (PACs) during past U.S. Congressional and Presidential campaign cycles. These drawings
  represent PACs and candidates as "nodes", and the cash flows between them as "links" connecting
  the nodes.
  </p>
  <p>
  A political action committee exists to raise and spend money for and against political candidates,
  in order to advance the political interests of its backers. It may represent a corporation (e.g.,
  AT&amp;T), a trade association ("National Association of Realtors"), or an ideological point of
  view ("Citizens for Lower Taxes").
  </p>
  <p>
  Direct contributions from PACs to candidate committees (e.g., "Nancy Pelosi for Congress") are
  subject to <a href="http://www.fec.gov/pages/brochures/contriblimits.shtml">strict limits</a>.
  However, a new kind of political action committee known as "Super PACs" came into existence in
  2010. Super PACs are allowed to raise and spend <i>unlimited</i> amounts of money to advocate for
  or against political candidates, but they are prohibited from contributing money directly to
  candidate committees. The expenditures made by Super PACs are sometimes referred to as "indirect
  contributions".
  </p>
  <p>
  The drawings generated by this tool represent both direct and indirect contributions as links
  between the nodes representing PACs and candidates.
  </p>
  <p>
  This tool is powered by campaign data provided by the <a href="http://www.opensecrets.org">
  Center for Responsive Politics</a>.
  </p>
  <p>
  Your feedback is valuable! Send questions and comments to 
  <a href="mailto:contact@seethestrings.org">contact@seethestrings.org</a>.
  </p>
  <hr>
  <h2>Ready to build your visualization?</h2>
  Let's get started then.
  <br><br>
  <form id="graphForm" action="graph.html" method="GET" target="blank_">
    For which election cycle would you like to view contributions?
    <br>
    <select name="cycle" id="cyclesList" size=1 onchange="queryAndUpdateAll()">
      <option value="2014" selected>2014</option>
      <option value="2012">2012</option>
      <option value="2010">2010</option>
    </select>
    <br><br>
    How would you like to specify which contributions you're interested in? You can choose a
    specific Congressional race, or you can choose one or more candidates or PACs.
    <br><br>
    <input type="radio" name="seedType" id="raceButton" value="Race"
        onclick="updateSeedType()" checked>
      Choose a race
    <br>
    <input type="radio" name="seedType" id="candidateButton" value="Candidate"
        onclick="updateSeedType()">
      Choose candidates
    <br>
    <input type="radio" name="seedType" id="pacButton" value="PAC"
        onclick="updateSeedType()">
      Choose PACs
    <br><br>
    <div id="raceFormSection" style="display:none">
      Which U.S. state or territory are you interested? (You can also select "Federal".)
      <br>
      <select name="states" id="statesList" size=1 onchange="queryAndShowRaces()">
      </select>
      <div id="raceFormSubSection" style="display:none">
        <br>
        Which race in the selected state or territory are you interested in?
        <br>
        <select name="race" id="racesList" style="width:60px" size=1>
        </select>
      </div>
    </div>
    <div id="candidateFormSection" style="display:none">
      Which candidates' 2014 campaign contributions would you like to see? (Select one or more.)
      <br>
      <select name="candidates" id="candidatesList" multiple="multiple" size=1>
      </select>
    </div>
    <div id="pacFormSection" style="display:none">
      Which political action committees' 2014 campaign contributions would you like to see?
      (Select one or more.)
      <br>
      <select name="pacs" id="pacsList" multiple="multiple" size=1>
      </select>
    </div>
    <br><br>
    <div id="detailsFormSection" style="display:inline">
      Would you like to see the contributions for each candidate <i>separately</i>, or for all of
      the selected candidates <i>combined</i>?
      <br>
      <input type="radio" name="groupCandidatesBy" value="Candidate" checked>
        Separate
      <br>
      <input type="radio" name="groupCandidatesBy" value="Selection">
        Combined
      <br><br>
      How would you like their contributions to be aggregated?
      <br>
      <input type="radio" name="groupContributionsBy" value="PAC" checked>
        By individual Political Action Committee
      <br>
      <input type="radio" name="groupContributionsBy" value="Industry">
        By industry (aggregated)
      <br>
      <input type="radio" name="groupContributionsBy" value="Sector">
        By sector (more aggregated)
      <br><br>
      Which contribution types would you like to see?
      <br>
      <input type="checkbox" name="contributionTypes" value="D" checked>
        Direct contributions to candidate committees
      <br>
      <input type="checkbox" name="contributionTypes" value="I" checked>
        Indirect expenditures to influence candidates' election prospects
      <br><br><br><br>
      <input type="button" style="width:300px;font-size:16pt"
          onclick="document.getElementById('graphForm').submit()" value="See the contributions!">
      <br><br><br><br>
    </div>
  </form>
</body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

function addOptionToSelectBox(selectBox, text, value) {
  var option = document.createElement("OPTION");
  option.text = text;
  option.value = value;
  selectBox.options.add(option);
}

function removeOptionsFromSelectBox(selectBox) {
  if (selectBox.options == null) {
    return;
  }
  selectBox.options.length = 0;
}

var cachedCandidates = null;
var cachedPacs = null;
var cachedRaces = null;

console.log("Trying to fetch all states")
d3.json("/states.json", showStates);

updateSeedType();
queryAndUpdateAll();

function queryAndUpdateAll() {
  queryAndShowCandidates();
  queryAndShowPacs();
  queryAndShowRaces();
}

function queryAndShowCandidates() {
  if (cachedCandidates == null) {
    console.log("Trying to fetch all candidates")
    d3.json("/candidates", storeAndShowCandidates);
  } else {
    showCandidates();
  }
}

function queryAndShowPacs() {
  if (cachedPacs == null) {
    console.log("Trying to fetch all pacs")
    d3.json("/pacs", storeAndShowPacs);
  } else {
    showPacs();
  }
}

function queryAndShowRaces() {
  if (cachedRaces == null) {
    console.log("Trying to fetch all races")
    d3.json("/races", storeAndShowRaces);
  } else {
    showRaces();
  }
}

function updateSeedType() {
  console.log("Updating seed type.")
  var raceButton = document.getElementById("raceButton");
  var candidateButton = document.getElementById("candidateButton");
  var pacButton = document.getElementById("pacButton");

  var raceFormSection = document.getElementById("raceFormSection");
  var candidateFormSection = document.getElementById("candidateFormSection");
  var pacFormSection = document.getElementById("pacFormSection");
  if (raceButton.checked == true) {
    console.log("Race mode");
    raceFormSection.style.display = "inline";
    candidateFormSection.style.display = "none";
    pacFormSection.style.display = "none";

    // TODO: racesList is an undeclared variable. How does this work?
    removeOptionsFromSelectBox(racesList);
    document.getElementById("raceFormSubSection").style.display = "none";

    document.getElementById("candidatesList").value = null;
    document.getElementById("pacsList").value = null;
  }
  if (candidateButton.checked == true) {
    console.log("Candidate mode");
    candidateFormSection.style.display = "inline";
    raceFormSection.style.display = "none";
    pacFormSection.style.display = "none";

    document.getElementById("statesList").value = null;
    document.getElementById("racesList").value = null;
    document.getElementById("pacsList").value = null;
  }
  if (pacButton.checked == true) {
    console.log("PAC mode");
    candidateFormSection.style.display = "none";
    raceFormSection.style.display = "none";
    pacFormSection.style.display = "inline";

    document.getElementById("statesList").value = null;
    document.getElementById("racesList").value = null;
    document.getElementById("candidatesList").value = null;
  }
}

function showStates(err, states) {
  if (err != null) {
    console.log("Error fetching states list from HTML page: " + JSON.stringify(err));
    // TODO: What should we do here?
  } else {
    console.log("Got a list of " + states.length + " states on HTML page");
  }

  var selectBox = document.getElementById("statesList");
  states.forEach(
      function(row) {
        addOptionToSelectBox(selectBox, row.statename, row.stateid);
      });

  selectBox.setAttribute("size", 10);
  // For some reason we have to manually null out a preselected value, even though we didn't select
  // any. This only seems to be necessary for single choice select boxes.
  selectBox.value = null;
}

function storeAndShowRaces(err, races) {
  if (err != null) {
    console.log("Error fetching races list from HTML page: " + JSON.stringify(err));
    // TODO: What should we do here?
  } else {
    console.log("Got a list of " + races.length + " races on HTML page");
  }

  cachedRaces = {};
  races.forEach(
      function(row) {
        if (cachedRaces[row.cycle] == null) {
          cachedRaces[row.cycle] = {};
        }
        if (cachedRaces[row.cycle][row.stateid] == null) {
          cachedRaces[row.cycle][row.stateid] = [];
        }
        cachedRaces[row.cycle][row.stateid].push(row);
      });

  showRaces();
}

function showRaces() {
  var stateid = document.getElementById("statesList").value;
  if (stateid != null && stateid != "") {
    var selectBox = document.getElementById("racesList");
    removeOptionsFromSelectBox(selectBox);

    var cycle = document.getElementById("cyclesList").value;
    console.log("Cycle " + cycle + ", state " + stateid);
    if (cachedRaces[cycle][stateid] != null) {
      cachedRaces[cycle][stateid].forEach(
          function(row) {
            addOptionToSelectBox(selectBox, row.racename, row.raceid);
          });
    }

    selectBox.setAttribute("size", 10);
    document.getElementById("raceFormSubSection").style.display = "block";
  }
}

function storeAndShowCandidates(err, candidates) {
  if (err != null) {
    console.log("Error fetching candidates list from HTML page: " + JSON.stringify(err));
    // TODO: What should we do here?
  } else {
    console.log("Got a list of " + candidates.length + " candidates on HTML page");
  }

  cachedCandidates = {};
  candidates.forEach(
      function(row) {
        if (cachedCandidates[row.cycle] == null) {
          cachedCandidates[row.cycle] = [];
        }
        cachedCandidates[row.cycle].push(row);
      });

  showCandidates();
}

function showCandidates() {
  var selectBox = document.getElementById("candidatesList");
  removeOptionsFromSelectBox(selectBox);

  var cycle = document.getElementById("cyclesList").value;
  cachedCandidates[cycle].forEach(
      function(row) {
        addOptionToSelectBox(selectBox, row.firstlastp, row.cid);
      });

  selectBox.setAttribute("size", 20);
}

function storeAndShowPacs(err, pacs) {
  if (err != null) {
    console.log("Error fetching PACs list from HTML page: " + JSON.stringify(err));
    // TODO: What should we do here?
  } else {
    console.log("Got a list of " + pacs.length + " PACs on HTML page");
  }

  cachedPacs = {};
  pacs.forEach(
      function(row) {
        if (cachedPacs[row.cycle] == null) {
          cachedPacs[row.cycle] = [];
        }
        cachedPacs[row.cycle].push(row);
      });

  showPacs();
}

function showPacs() {
  var selectBox = document.getElementById("pacsList");
  removeOptionsFromSelectBox(selectBox);

  var cycle = document.getElementById("cyclesList").value;
  cachedPacs[cycle].forEach(
      function(row) {
        addOptionToSelectBox(selectBox, row.pacshort, row.cmteid);
      });

  selectBox.setAttribute("size", 20);
}

</script>
</html>